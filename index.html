<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- å¼•å…¥ Chart.js ç”¨æ–¼è£½ä½œåœ–è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f4f4f9; padding: 20px; }
      .container { max-width: 1200px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      
      h1 { text-align: center; color: #333; margin-bottom: 30px; }
      
      .controls { margin-bottom: 20px; text-align: center; }
      select { padding: 10px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 200px; cursor: pointer; }

      /* åœ–è¡¨å€åŸŸ */
      .chart-container { position: relative; height: 400px; width: 100%; margin-bottom: 40px; }

      /* è¡¨æ ¼å€åŸŸ */
      .table-wrapper { overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
      th, td { border: 1px solid #ddd; padding: 12px 8px; text-align: center; }
      th { background-color: #2c3e50; color: white; position: sticky; top: 0; white-space: nowrap; }
      tr:nth-child(even) { background-color: #f9f9f9; }
      tr:hover { background-color: #f1f1f1; }

      /* åƒ¹æ ¼æ¯”è¼ƒæ¨£å¼ */
      .price-low { color: #27ae60; font-weight: bold; } /* ä½æ–¼å¹³å‡ (ç¶ è‰²) */
      .price-high { color: #c0392b; font-weight: bold; } /* é«˜æ–¼å¹³å‡ (ç´…è‰²) */
      
      .legend-info { text-align: right; font-size: 0.9em; margin-bottom: 5px; color: #666; }
      .loading { text-align: center; font-size: 1.2em; color: #666; padding: 50px; }
      .error-msg { color: red; text-align: center; padding: 20px; display: none; }
      .env-badge { text-align: center; font-size: 0.8em; color: #aaa; margin-top: 20px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“Š åŸç‰©æ–™åƒ¹æ ¼æ¡è³¼åˆ†æçœ‹æ¿</h1>
      
      <div class="controls">
        <label for="yearSelect">é¸æ“‡åˆ†æå¹´åº¦ï¼š</label>
        <select id="yearSelect" onchange="updateDashboard()">
          <option value="" disabled selected>è³‡æ–™è¼‰å…¥ä¸­...</option>
        </select>
      </div>

      <div id="content" style="display:none;">
        <div class="chart-container">
          <canvas id="priceChart"></canvas>
        </div>

        <div class="legend-info">
          * ç¶ è‰²æ•¸å­—ï¼šä½æ–¼æ­·å²å¹³å‡ (è²·å…¥è¨Šè™Ÿ) | ç´…è‰²æ•¸å­—ï¼šé«˜æ–¼æ­·å²å¹³å‡ (æˆæœ¬æ³¨æ„) | ç°è‰²å­—ï¼šç­‰æ–¼å¹³å‡
        </div>
        
        <div class="table-wrapper">
          <table id="priceTable">
            <thead>
              <!-- è¡¨é ­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </thead>
            <tbody>
              <!-- å…§å®¹å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>

      <div id="loader" class="loading">æ­£åœ¨é€£ç·šè‡³ Google è©¦ç®—è¡¨...</div>
      <div id="error-box" class="error-msg"></div>
      <div id="env-indicator" class="env-badge"></div>
    </div>

    <script>
      // ğŸŸ¢ğŸŸ¢ğŸŸ¢ è«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Google è©¦ç®—è¡¨ç¶²å€ ğŸŸ¢ğŸŸ¢ğŸŸ¢
      const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbyOrLO5Cv5cfX6a01do1HuOQ4MvIsmQeqm6rvrWZXgTYFA935IkQwuvfishmjOTswbmMQ/exec";

      let fullData = {}; 
      let myChart = null;

      // --- æ¨¡æ“¬æ•¸æ“š (é è¦½ç”¨) ---
      const mockData = {
        records: [
          { year: 2024, month: 1, prices: [24.5, 24.5, 34.1, 26.3, 27, 26.8, 27.6, 43, 64, 68] },
          { year: 2024, month: 2, prices: [24.8, 24, 34.1, 26.3, 27, 26.8, 27.6, 43, 65, 69] },
          { year: 2024, month: 3, prices: [25.1, 24.2, 34.5, 26.5, 27.2, 26.8, 27.8, 43.5, 66, 70] }
        ],
        averages: [24.3, 23.3, 37.5, 23.65, 23.6, 24.35, 25.65, 40, 67, 75],
        headers: [
          "éµæ¿(9T*8'*40')", "é‹¼æ²(6T*5')", "è€ç£¨æ¿(9T)", "è§’éµ(50*6)", 
          "æ‰éµ(100*9)", "æ§½éµ(150)", "Hå‹é‹¼(150*150)", "éµç®¡(14\")", 
          "ä¸éŠ¹é‹¼(NO.1)", "ä¸éŠ¹é‹¼(2B)"
        ]
      };

      // ç¶²é è¼‰å…¥æ™‚åŸ·è¡Œ
      window.onload = function() {
        if (typeof google === 'undefined' || typeof google.script === 'undefined') {
          console.warn('Google Apps Script ç’°å¢ƒæœªåµæ¸¬åˆ°ï¼Œä½¿ç”¨æ¨¡æ“¬è³‡æ–™ã€‚');
          document.getElementById('env-indicator').innerText = 'ç›®å‰æ¨¡å¼ï¼šé è¦½æ¸¬è©¦ (æ¨¡æ“¬è³‡æ–™)';
          setTimeout(() => { initDashboard(mockData); }, 800);
        } else {
          // æ­£å¼ç’°å¢ƒï¼šå°‡å‰ç«¯è¨­å®šçš„ç¶²å€å‚³çµ¦å¾Œç«¯
          document.getElementById('env-indicator').innerText = 'ç›®å‰æ¨¡å¼ï¼šæ­£å¼é€£ç·š (Google Sheets)';
          
          // å‘¼å«å¾Œç«¯ä¸¦å¸¶å…¥ç¶²å€åƒæ•¸
          google.script.run
            .withSuccessHandler(initDashboard)
            .withFailureHandler(showError)
            .getData(GOOGLE_SHEET_URL); 
        }
      };

      function showError(error) {
        document.getElementById('loader').style.display = 'none';
        const errorBox = document.getElementById('error-box');
        errorBox.style.display = 'block';
        errorBox.innerHTML = `
          <strong>ç™¼ç”ŸéŒ¯èª¤ï¼šç„¡æ³•è®€å–è³‡æ–™</strong><br>
          <small>${error.message}</small><br><br>
          è«‹æª¢æŸ¥ Index.html ç¨‹å¼ç¢¼ç¬¬ 103 è¡Œï¼Œç¢ºèªå·²è²¼ä¸Šæ­£ç¢ºçš„ Google è©¦ç®—è¡¨ç¶²å€ã€‚
        `;
      }

      function initDashboard(data) {
        fullData = data;
        
        if (!data || !data.records || data.records.length === 0) {
          showError({message: "è®€å–åˆ°çš„è³‡æ–™ç‚ºç©ºï¼Œè«‹æª¢æŸ¥è©¦ç®—è¡¨å…§å®¹æ˜¯å¦ç©ºç™½ã€‚"});
          return;
        }

        const years = [...new Set(data.records.map(item => item.year))].sort((a,b) => b-a);
        
        const select = document.getElementById('yearSelect');
        select.innerHTML = '';
        years.forEach(year => {
          const option = document.createElement('option');
          option.value = year;
          option.text = year + ' å¹´';
          select.appendChild(option);
        });

        document.getElementById('loader').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        if (years.length > 0) {
           select.value = years[0];
           updateDashboard();
        }
      }

      function updateDashboard() {
        const select = document.getElementById('yearSelect');
        if (!select.value) return;

        const selectedYear = parseInt(select.value);
        const filteredRecords = fullData.records.filter(r => r.year === selectedYear);
        const materials = fullData.headers;
        const averages = fullData.averages;

        if (filteredRecords.length === 0) {
            alert("è©²å¹´åº¦æ²’æœ‰æ•¸æ“š");
            return;
        }

        renderChart(filteredRecords, materials);
        renderTable(filteredRecords, materials, averages);
      }

      function renderChart(records, materials) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        const months = records.map(r => r.month + 'æœˆ');
        
        const colors = [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', 
          '#FF9F40', '#8e44ad', '#2c3e50', '#27ae60', '#e67e22'
        ];

        const datasets = materials.map((material, index) => {
          return {
            label: material,
            data: records.map(r => r.prices[index]),
            borderColor: colors[index],
            backgroundColor: colors[index],
            fill: false,
            tension: 0.1,
            pointRadius: 4,
            pointHoverRadius: 6
          };
        });

        if (myChart) {
          myChart.destroy();
        }

        myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              title: {
                display: true,
                text: 'å¹´åº¦åƒ¹æ ¼è¶¨å‹¢åœ–',
                font: { size: 16 }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                   label: function(context) {
                      return context.dataset.label + ': ' + context.parsed.y;
                   }
                }
              },
              legend: {
                position: 'bottom',
                labels: { usePointStyle: true, padding: 20 }
              }
            },
            scales: {
              y: {
                title: { display: true, text: 'å–®åƒ¹' },
                beginAtZero: false
              }
            }
          }
        });
      }

      function renderTable(records, materials, averages) {
        const tableHead = document.querySelector('#priceTable thead');
        const tableBody = document.querySelector('#priceTable tbody');
        
        let headHtml = '<tr><th>æœˆä»½</th>';
        materials.forEach(m => {
          headHtml += `<th>${m}</th>`;
        });
        headHtml += '</tr>';
        
        headHtml += '<tr style="background-color: #e8f6f3; font-weight:bold; color:#444;"><td>å¹³å‡åŸºæº–</td>';
        averages.forEach(avg => {
          let displayAvg = (typeof avg === 'number') ? Math.round(avg * 100) / 100 : avg;
          headHtml += `<td>${displayAvg}</td>`;
        });
        headHtml += '</tr>';
        
        tableHead.innerHTML = headHtml;

        let bodyHtml = '';
        records.forEach(row => {
          bodyHtml += `<tr><td>${row.month}æœˆ</td>`;
          
          row.prices.forEach((price, index) => {
            const avg = averages[index];
            let className = '';
            let displayPrice = price;

            if (typeof price === 'number' && typeof avg === 'number') {
              if (price < avg) {
                className = 'price-low';
                displayPrice += ' â–¼'; 
              } else if (price > avg) {
                className = 'price-high';
                displayPrice += ' â–²';
              }
            }

            bodyHtml += `<td class="${className}">${displayPrice}</td>`;
          });
          
          bodyHtml += '</tr>';
        });
        tableBody.innerHTML = bodyHtml;
      }
    </script>
  </body>
</html>
